/**
 * Sistema Auto-Solucionador NexyPass v13.0
 * Detecta y corrige autom√°ticamente errores comunes
 */

import React from 'react';
import { LocalStorageDB } from '../lib/supabase';
import toast from 'react-hot-toast';

export class AutoFixer {
  private static instance: AutoFixer;
  private localDB = LocalStorageDB.getInstance();
  private fixInterval: NodeJS.Timeout | null = null;

  static getInstance(): AutoFixer {
    if (!AutoFixer.instance) {
      AutoFixer.instance = new AutoFixer();
    }
    return AutoFixer.instance;
  }

  constructor() {
    this.startAutoFixer();
  }

  private startAutoFixer(): void {
    // Ejecutar auto-correcciones cada 60 segundos
    this.fixInterval = setInterval(() => {
      this.runDiagnostics();
    }, 60000);

    // Ejecutar diagn√≥stico inicial
    setTimeout(() => {
      this.runDiagnostics();
    }, 5000);
  }

  private runDiagnostics(): void {
    try {
      this.fixLocalStorageIssues();
      this.fixDataIntegrity();
      this.fixMemoryLeaks();
      this.fixUIState();
      this.optimizePerformance();
    } catch (error) {
      console.error('Error en auto-diagn√≥stico:', error);
    }
  }

  private fixLocalStorageIssues(): void {
    try {
      // Verificar y reparar datos corruptos en localStorage
      const keys = ['nexypass_users', 'nexypass_products', 'nexypass_orders', 'nexypass_transactions', 'nexypass_recharge_requests', 'nexypass_stock_items'];
      
      keys.forEach(key => {
        try {
          const data = localStorage.getItem(key);
          if (data) {
            JSON.parse(data); // Verificar que sea JSON v√°lido
          }
        } catch (error) {
          console.log(`üîß Auto-Fix: Reparando ${key} corrupto`);
          localStorage.removeItem(key);
          
          // Inicializar con array vac√≠o
          localStorage.setItem(key, JSON.stringify([]));
        }
      });

      // Verificar usuario actual
      try {
        const savedUser = localStorage.getItem('nexypass_user');
        if (savedUser) {
          JSON.parse(savedUser);
        }
      } catch (error) {
        console.log('üîß Auto-Fix: Reparando datos de usuario corruptos');
        localStorage.removeItem('nexypass_user');
      }
    } catch (error) {
      console.error('Error fixing localStorage:', error);
    }
  }

  private fixDataIntegrity(): void {
    try {
      // Verificar integridad de productos y stock
      const products = this.localDB.getProducts();
      const stockItems = this.localDB.getStockItems();
      
      // Eliminar stock hu√©rfano (sin producto asociado)
      const validProductIds = products.map(p => p.id);
      const validStock = stockItems.filter(stock => validProductIds.includes(stock.product_id));
      
      if (validStock.length !== stockItems.length) {
        console.log('üîß Auto-Fix: Eliminando stock hu√©rfano');
        this.localDB.saveStockItems(validStock);
      }

      // Verificar √≥rdenes
      const orders = this.localDB.getOrders();
      const users = this.localDB.getUsers();
      const validUserIds = users.map(u => u.id);
      
      // Filtrar √≥rdenes con usuarios v√°lidos
      const validOrders = orders.filter(order => validUserIds.includes(order.userId));
      
      if (validOrders.length !== orders.length) {
        console.log('üîß Auto-Fix: Limpiando √≥rdenes hu√©rfanas');
        this.localDB.saveOrders(validOrders);
      }

      // Actualizar estado de √≥rdenes expiradas
      const now = new Date();
      const updatedOrders = validOrders.map(order => {
        if (order.status === 'active' && new Date(order.expiresAt) < now) {
          return { ...order, status: 'expired' as const };
        }
        return order;
      });
      
      const expiredCount = updatedOrders.filter(o => o.status === 'expired').length - orders.filter(o => o.status === 'expired').length;
      if (expiredCount > 0) {
        console.log(`üîß Auto-Fix: Marcando ${expiredCount} √≥rdenes como expiradas`);
        this.localDB.saveOrders(updatedOrders);
      }
    } catch (error) {
      console.error('Error fixing data integrity:', error);
    }
  }

  private fixMemoryLeaks(): void {
    try {
      // Limpiar event listeners hu√©rfanos
      const events = ['online', 'offline', 'beforeunload', 'unload'];
      events.forEach(event => {
        // Remover listeners duplicados (esto es una simplificaci√≥n)
        if (window.addEventListener.toString().includes('native code')) {
          // Solo en navegadores que soportan esto
        }
      });

      // Limpiar intervalos y timeouts hu√©rfanos
      const highestTimeoutId = setTimeout(() => {}, 0);
      for (let i = 0; i < highestTimeoutId; i++) {
        clearTimeout(i);
      }
      clearTimeout(highestTimeoutId);

      // Forzar garbage collection si est√° disponible
      if ((window as any).gc) {
        (window as any).gc();
      }
    } catch (error) {
      console.error('Error fixing memory leaks:', error);
    }
  }

  private fixUIState(): void {
    try {
      // Verificar y corregir estado de scroll
      if (document.body.style.overflow === 'hidden' && window.location.pathname !== '/auth') {
        document.body.style.overflow = 'hidden'; // Mantener para la app
      }

      // Limpiar modales hu√©rfanos
      const modals = document.querySelectorAll('[role="dialog"], .modal, .overlay');
      modals.forEach(modal => {
        if (modal instanceof HTMLElement) {
          if (modal.style.display === 'none' || modal.style.visibility === 'hidden') {
            modal.remove();
          }
        }
      });

      // Verificar viewport en m√≥viles
      const viewport = document.querySelector('meta[name="viewport"]');
      if (viewport && !viewport.getAttribute('content')?.includes('user-scalable=no')) {
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no');
      }
    } catch (error) {
      console.error('Error fixing UI state:', error);
    }
  }

  private optimizePerformance(): void {
    try {
      // Limpiar localStorage si est√° muy lleno
      const storageSize = JSON.stringify(localStorage).length;
      const maxSize = 5 * 1024 * 1024; // 5MB

      if (storageSize > maxSize) {
        console.log('üîß Auto-Fix: Optimizando almacenamiento local');
        
        // Mantener solo los √∫ltimos 100 registros de transacciones
        const transactions = this.localDB.getTransactions();
        if (transactions.length > 100) {
          const recentTransactions = transactions
            .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
            .slice(0, 100);
          this.localDB.saveTransactions(recentTransactions);
        }

        // Limpiar √≥rdenes muy antiguas (m√°s de 6 meses)
        const orders = this.localDB.getOrders();
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        
        const recentOrders = orders.filter(order => 
          new Date(order.createdAt) > sixMonthsAgo
        );
        
        if (recentOrders.length !== orders.length) {
          this.localDB.saveOrders(recentOrders);
        }
      }

      // Optimizar im√°genes cargadas
      const images = document.querySelectorAll('img');
      images.forEach(img => {
        if (img.complete && img.naturalWidth === 0) {
          // Imagen rota, usar placeholder
          img.src = 'https://images.pexels.com/photos/4348401/pexels-photo-4348401.jpeg?auto=compress&cs=tinysrgb&w=400';
        }
      });
    } catch (error) {
      console.error('Error optimizing performance:', error);
    }
  }

  // M√©todo para forzar una reparaci√≥n completa
  public forceFullRepair(): void {
    try {
      console.log('üîß Iniciando reparaci√≥n completa del sistema...');
      
      this.runDiagnostics();
      
      // Verificar conectividad
      if (!navigator.onLine) {
        toast.custom((t) => (
          <div className="bg-slate-800 border border-yellow-500/30 rounded-xl p-4 text-center shadow-lg">
            <p className="text-yellow-400 font-semibold">üì± Modo Offline Detectado</p>
            <p className="text-gray-300 text-sm mt-1">Sistema funcionando con almacenamiento local</p>
          </div>
        ), { duration: 3000 });
      }

      // Verificar integridad de datos cr√≠ticos
      const criticalData = {
        users: this.localDB.getUsers(),
        products: this.localDB.getProducts(),
        orders: this.localDB.getOrders()
      };

      let hasIssues = false;
      Object.entries(criticalData).forEach(([key, data]) => {
        if (!Array.isArray(data)) {
          console.log(`üîß Reparando ${key} - no es array v√°lido`);
          localStorage.setItem(`nexypass_${key}`, JSON.stringify([]));
          hasIssues = true;
        }
      });

      if (hasIssues) {
        toast.success('üîß Sistema reparado autom√°ticamente', {
          duration: 4000,
        });
      }

      console.log('‚úÖ Reparaci√≥n completa finalizada');
    } catch (error) {
      console.error('Error en reparaci√≥n completa:', error);
      
      // √öltimo recurso: reset completo
      this.emergencyReset();
    }
  }

  private emergencyReset(): void {
    try {
      console.log('üö® Ejecutando reset de emergencia...');
      
      // Guardar usuario actual si existe
      const currentUser = localStorage.getItem('nexypass_user');
      
      // Limpiar todo el localStorage de NexyPass
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith('nexypass_')) {
          localStorage.removeItem(key);
        }
      });

      // Restaurar usuario si exist√≠a
      if (currentUser) {
        try {
          JSON.parse(currentUser); // Verificar que sea v√°lido
          localStorage.setItem('nexypass_user', currentUser);
        } catch (error) {
          // Usuario corrupto, no restaurar
        }
      }

      // Inicializar datos b√°sicos
      const emptyData = JSON.stringify([]);
      localStorage.setItem('nexypass_users', emptyData);
      localStorage.setItem('nexypass_products', emptyData);
      localStorage.setItem('nexypass_orders', emptyData);
      localStorage.setItem('nexypass_transactions', emptyData);
      localStorage.setItem('nexypass_recharge_requests', emptyData);
      localStorage.setItem('nexypass_stock_items', emptyData);

      toast.success('üîß Sistema reiniciado y reparado', {
        duration: 5000,
      });

      // Recargar p√°gina despu√©s de 2 segundos
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } catch (error) {
      console.error('Error en reset de emergencia:', error);
      // √öltimo recurso: recargar p√°gina
      window.location.reload();
    }
  }

  public destroy(): void {
    if (this.fixInterval) {
      clearInterval(this.fixInterval);
    }
  }
}

// Inicializar auto-fixer
const autoFixer = AutoFixer.getInstance();

// Exponer m√©todo de reparaci√≥n forzada globalmente para debugging
(window as any).forceRepair = () => autoFixer.forceFullRepair();

export default autoFixer;